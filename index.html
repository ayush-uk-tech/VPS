
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minerva Bot - Intelligent HR Partner</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        bot: {
                            main: '#2C6CB7',
                            teal: '#66C3D0',
                            sky: '#AEDBE2',
                            gray: '#C4C4C5',
                            light: '#F3F4F6',
                            bg: '#F9FAFB',
                            success: '#10B981',
                            link: '#3B82F6',
                            total: '#6366f1'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'wave': 'wave 1.3s linear infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        wave: {
                            '0%, 60%, 100%': { transform: 'translateY(0)' },
                            '30%': { transform: 'translateY(-6px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .chat-box::-webkit-scrollbar { width: 6px; }
        .chat-box::-webkit-scrollbar-track { background: transparent; }
        .chat-box::-webkit-scrollbar-thumb { background: #C4C4C5; border-radius: 10px; }
        textarea { resize: none; }
        input[type="file"] { display: none; }

        .minerva-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .minerva-table th { background-color: #F3F4F6; color: #374151; font-weight: 600; text-align: left; padding: 10px; border-bottom: 2px solid #E5E7EB; }
        .minerva-table td { padding: 10px; border-bottom: 1px solid #F3F4F6; color: #4B5563; }
        .minerva-table tr:last-child td { border-bottom: none; }
        .minerva-table tr:hover { background-color: #F9FAFB; }

        .dot-1 { animation-delay: 0s; }
        .dot-2 { animation-delay: 0.1s; }
        .dot-3 { animation-delay: 0.2s; }
        .typing-cursor::after { content: '|'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .tick-icon { transition: all 0.3s ease; }

        .material-symbols-rounded.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="bg-gray-100 h-[100dvh] w-full flex items-center justify-center font-sans text-gray-800">

    <div id="chatbot-widget" class="w-full h-full md:w-[1000px] md:h-[90vh] bg-white md:rounded-xl shadow-2xl overflow-hidden flex flex-col border border-bot-gray relative">

        <header class="bg-bot-main p-4 md:p-5 flex items-center justify-between shadow-md relative z-10 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/10 flex items-center justify-center border border-bot-teal relative overflow-hidden backdrop-blur-sm">
                    <span class="material-symbols-rounded text-white text-lg md:text-xl">smart_toy</span>
                </div>
                <div>
                    <h2 class="text-white font-bold text-base md:text-lg tracking-wide">Minerva Bot</h2>
                    <p class="text-bot-sky text-[10px] md:text-xs font-medium">Analytics & Recruitment Partner</p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="exportToPDF()" class="text-white/70 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all flex items-center gap-1" title="Download Chat as PDF">
                    <span class="material-symbols-rounded text-xl">picture_as_pdf</span>
                </button>
                <button onclick="clearChat()" class="text-white/70 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all" title="Clear Chat">
                    <span class="material-symbols-rounded text-xl">delete</span>
                </button>
            </div>
        </header>

        <ul id="chat-box" class="chat-box flex-1 overflow-y-auto p-4 md:p-5 pb-2 space-y-6 bg-white scroll-smooth">
            <li class="flex flex-col gap-2 animate-slide-up">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-rounded w-8 h-8 rounded-full bg-bot-light text-bot-main flex items-center justify-center text-lg flex-shrink-0">smart_toy</span>
                    <div class="bg-bot-light text-gray-700 p-3.5 rounded-2xl rounded-tl-none text-sm shadow-sm max-w-[85%] border border-gray-100">
                        <p class="leading-relaxed">Hello! I can help you draft Job Descriptions, analyze salaries, and visualize HR data. <br><br>Try: <b>"Draft a Job Spec for a Big Data Architect"</b></p>
                        <span class="block text-[10px] text-gray-400 text-right mt-1 font-medium timestamp-bot"></span>
                    </div>
                </div>
            </li>
        </ul>

        <div class="p-3 md:p-4 bg-white z-20 shrink-0 border-t border-gray-50">
            <form onsubmit="handleChat(event)" class="flex items-end gap-2 w-full">
                <input type="file" id="file-upload" onchange="handleFileSelect(this)" multiple class="hidden">
                <textarea id="chat-input" rows="1" placeholder="Type a message..." class="flex-1 bg-bot-bg rounded-2xl border-none focus:outline-none focus:ring-0 text-gray-700 placeholder-gray-500 resize-none py-3 px-4 max-h-24 text-[15px] leading-relaxed transition-all" required></textarea>
                <div class="flex items-end gap-1 flex-shrink-0 mb-1">
                    <button type="submit" class="text-bot-main hover:bg-bot-light p-2 rounded-full transition-all flex items-center justify-center">
                        <span class="material-symbols-rounded text-2xl filled">send</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // âš ï¸ REPLACE WITH YOUR N8N URL âš ï¸
    const N8N_WEBHOOK_URL = "https://n8n.srv1153795.hstgr.cloud/webhook/a85ee8e4-ca37-4c8e-afd1-9db471ef8014";

    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');

    document.querySelector('.timestamp-bot').textContent = getCurrentTime();

    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.querySelector('form').requestSubmit();
        }
    });

    // --- UTILS ---
    function getCurrentTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); }
    function scrollToBottom() { chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }); }

    function getFlagEmoji(countryCode) {
        if (!countryCode) return '';
        if (/[^\x00-\x7F]/.test(countryCode)) return countryCode;
        const codeMap = {
            'IN': 'ðŸ‡®ðŸ‡³', 'US': 'ðŸ‡ºðŸ‡¸', 'UK': 'ðŸ‡¬ðŸ‡§', 'GB': 'ðŸ‡¬ðŸ‡§',
            'RO': 'ðŸ‡·ðŸ‡´', 'DE': 'ðŸ‡©ðŸ‡ª', 'FR': 'ðŸ‡«ðŸ‡·', 'PT': 'ðŸ‡µðŸ‡¹',
            'ES': 'ðŸ‡ªðŸ‡¸', 'IT': 'ðŸ‡®ðŸ‡¹', 'CA': 'ðŸ‡¨ðŸ‡¦', 'AU': 'ðŸ‡¦ðŸ‡º'
        };
        return codeMap[countryCode.toUpperCase()] || countryCode;
    }

    window.copyJobSpec = function(btn) {
        const card = btn.closest('.job-spec-card');
        const content = card.innerText.replace('Copy', '').trim();
        navigator.clipboard.writeText(content).then(() => {
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-rounded text-sm">check</span> Copied`;
            btn.classList.add('text-green-600', 'bg-green-100');
            setTimeout(() => { btn.innerHTML = originalText; btn.classList.remove('text-green-600', 'bg-green-100'); }, 2000);
        });
    }

    window.downloadChart = function(canvasId) {
        const canvas = document.getElementById(canvasId);
        if(canvas) {
            const link = document.createElement('a');
            link.download = `chart-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    }

    window.downloadTableCSV = function(btn) {
        const table = btn.closest('.table-container').querySelector('table');
        if (!table) return;
        let csv = [];
        const rows = table.querySelectorAll('tr');
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll('td, th');
            for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
            csv.push(row.join(","));
        }
        const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
        const downloadLink = document.createElement("a");
        downloadLink.download = `data-${Date.now()}.csv`;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }

    // --- MAIN CHAT LOGIC ---
    async function handleChat(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;

        const tickId = appendMessage(message, 'user');
        chatInput.value = '';
        chatInput.style.height = 'auto';
        const tickElement = document.getElementById(tickId);

        setTimeout(() => { if(tickElement && tickElement.getAttribute('data-status') === 'sent') { tickElement.innerText = 'done_all'; tickElement.setAttribute('data-status', 'delivered'); } }, 1000);

        const readTimer = setTimeout(() => {
            if(tickElement) { tickElement.classList.remove('text-blue-200', 'opacity-70'); tickElement.classList.add('text-bot-sky', 'opacity-100'); tickElement.setAttribute('data-status', 'read'); }
            showTyping();
        }, 1500);

        try {
            const response = await sendToN8N(message);
            clearTimeout(readTimer);
            removeTyping();
            if(tickElement) { tickElement.innerText = 'done_all'; tickElement.classList.remove('text-blue-200', 'opacity-70'); tickElement.classList.add('text-bot-sky', 'opacity-100'); tickElement.setAttribute('data-status', 'read'); }

            let data = Array.isArray(response) ? response[0] : response;
            let replyText = typeof data === 'string' ? data : (data.answer || data.output || JSON.stringify(data));
            let suggestions = data.suggestions || [];
            let chart = data.chart || null;
            let table = data.table || null;
            let source = data.source || null;
            let salary_card = data.salary_card || null;
            let job_spec = data.job_spec || null;

            appendBotResponse(replyText, suggestions, chart, table, source, salary_card, job_spec);

        } catch (error) {
            console.error(error);
            clearTimeout(readTimer); removeTyping();
            appendBotResponse(`Connection Error: ${error.message}`);
        }
    }

    async function sendToN8N(userMessage) {
        const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage, sessionId: "user-web-demo-1" })
        });
        return await response.json();
    }

    function appendMessage(text, sender) {
        const time = getCurrentTime();
        const tickId = 'tick-' + Date.now();
        const li = document.createElement('li');
        li.className = 'flex items-end gap-2 animate-slide-up justify-end';
        li.innerHTML = `
            <div class="bg-bot-main text-white p-3 rounded-2xl rounded-tr-none text-sm shadow-md max-w-[85%] relative">
                <p class="leading-relaxed whitespace-pre-wrap pr-1">${text}</p>
                <div class="flex items-center justify-end gap-1 mt-1">
                    <span class="text-[10px] text-blue-200 font-medium opacity-80">${time}</span>
                    <span id="${tickId}" data-status="sent" class="material-symbols-rounded text-[14px] text-blue-200 opacity-70 tick-icon">check</span>
                </div>
            </div>`;
        chatBox.appendChild(li); scrollToBottom();
        return tickId;
    }

    function typeWriter(element, text, speed = 10) {
        return new Promise(resolve => {
            let i = 0;
            function type() {
                if (i < text.length) { element.textContent += text.charAt(i); i++; scrollToBottom(); setTimeout(type, speed); } else { resolve(); }
            } type();
        });
    }

    // --- RESPONSE RENDERER (SIMPLIFIED SALARY) ---
    async function appendBotResponse(text, suggestions = [], chartData = null, tableData = null, source = null, salaryCard = null, jobSpec = null) {
        const time = getCurrentTime();
        const li = document.createElement('li');
        li.className = 'flex flex-col gap-2 animate-slide-up';

        let chartId = 'chart-' + Date.now();
        let chartHTML = chartData ? `
            <div class="bg-white p-3 rounded-lg shadow-inner mt-2 w-full h-72 border border-gray-100 relative group block">
                <div class="absolute top-2 right-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="downloadChart('${chartId}')" class="bg-white/90 p-1.5 rounded text-gray-500 hover:text-bot-main shadow-sm border border-gray-200" title="Download Chart (PNG)">
                        <span class="material-symbols-rounded text-lg">download</span>
                    </button>
                </div>
                <div style="position: relative; height: 100%; width: 100%;">
                    <canvas id="${chartId}"></canvas>
                </div>
            </div>` : '';

        let tableHTML = '';
        if (tableData && tableData.headers) {
            let thead = tableData.headers.map(h => `<th>${h}</th>`).join('');
            let tbody = tableData.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
            tableHTML = `
            <div class="table-container overflow-x-auto mt-3 rounded-lg border border-gray-200 shadow-sm fade-in-element opacity-0 hidden transition-opacity duration-500">
                <div class="flex justify-end p-2 bg-gray-50 border-b border-gray-100">
                    <button onclick="downloadTableCSV(this)" class="text-xs text-bot-link font-medium flex items-center gap-1 hover:underline">
                        <span class="material-symbols-rounded text-sm">csv</span> Download CSV
                    </button>
                </div>
                <table class="minerva-table bg-white"><thead><tr>${thead}</tr></thead><tbody>${tbody}</tbody></table>
            </div>`;
        }

        // --- JOB SPEC LOGIC ---
        let jobSpecHTML = '';
        if (jobSpec) {
            const formatList = (val) => {
                if (!val || val === 'N/A') return '';
                if (Array.isArray(val)) return val.map(v => `<li>${v}</li>`).join('');
                return `<li>${val}</li>`;
            };

            const responsibilities = formatList(jobSpec.responsibilities);
            const skills = formatList(jobSpec.skills);
            const quals = formatList(jobSpec.qualifications || jobSpec.requirements);
            const certs = formatList(jobSpec.certifications);

            let sectionsHTML = '';
            const summaryText = jobSpec.summary || jobSpec.description || jobSpec.job_summary;
            if(summaryText) {
                sectionsHTML += `<div class="mt-2"><strong class="font-semibold text-gray-900 block mb-1">Job Summary:</strong><p class="leading-relaxed opacity-90">${summaryText}</p></div>`;
            }
            if(quals) {
                sectionsHTML += `<div class="mt-2"><strong class="font-semibold text-gray-900 block mb-1">Qualifications:</strong><ul class="list-disc pl-4 space-y-1 opacity-90">${quals}</ul></div>`;
            }
            if(certs) {
                sectionsHTML += `<div class="mt-2"><strong class="font-semibold text-gray-900 block mb-1">Certifications:</strong><ul class="list-disc pl-4 space-y-1 opacity-90">${certs}</ul></div>`;
            }
            if(responsibilities) {
                sectionsHTML += `<div class="mt-2"><strong class="font-semibold text-gray-900 block mb-1">Key Responsibilities:</strong><ul class="list-disc pl-4 space-y-1 opacity-90">${responsibilities}</ul></div>`;
            }
            if(skills) {
                sectionsHTML += `<div class="mt-2"><strong class="font-semibold text-gray-900 block mb-1">Key Skills:</strong><ul class="list-disc pl-4 space-y-1 opacity-90">${skills}</ul></div>`;
            }

            jobSpecHTML = `
            <div class="job-spec-card mt-4 bg-white border border-gray-200 rounded-xl p-5 relative shadow-sm fade-in-element opacity-0 hidden transition-opacity duration-500 text-gray-800">
                <button onclick="copyJobSpec(this)" class="absolute top-3 right-3 flex items-center gap-1 bg-gray-50 hover:bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium border border-gray-200 transition-all" title="Copy Description">
                    <span class="material-symbols-rounded text-sm">content_copy</span> Copy
                </button>
                <h3 class="font-bold text-lg text-gray-800 mb-4 border-b border-gray-100 pb-2">Job Specification</h3>
                <div class="space-y-3 text-sm">
                    <p><strong class="font-semibold text-gray-900">Job Title:</strong> ${jobSpec.title || jobSpec.role}</p>
                    <p><strong class="font-semibold text-gray-900">Job Code:</strong> ${jobSpec.job_code || 'N/A'}</p>
                    <p><strong class="font-semibold text-gray-900">Reporting To:</strong> ${jobSpec.reporting_to || jobSpec.reports_to || 'N/A'}</p>
                    <p><strong class="font-semibold text-gray-900">Experience:</strong> ${jobSpec.experience || jobSpec.seniority || 'N/A'}</p>
                    ${sectionsHTML}
                </div>
            </div>`;
        }

        // --- SIMPLIFIED SALARY LOGIC (NO CARD, NO TOGGLE) ---
        let salaryHTML = '';
        if (salaryCard) {
            const flag = getFlagEmoji(salaryCard.flag || salaryCard.location_code);
            const location = salaryCard.location ? `${salaryCard.location} ${flag}` : '';
            const role = salaryCard.role || '';
            const header = role || location ? `<p class="font-bold text-gray-800 mb-1">${role} ${location}</p>` : '';
            
            if (salaryCard.base_l1) {
                // Tiered data
                salaryHTML = `
                <div class="mt-3 pt-3 border-t border-gray-200 space-y-1 text-sm fade-in-element opacity-0 hidden transition-opacity duration-500">
                    ${header}
                    <div class="flex justify-between"><span class="text-gray-600">Level 1 (Junior):</span> <span class="font-medium text-gray-900">${salaryCard.base_l1}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Level 2 (Mid):</span> <span class="font-medium text-gray-900">${salaryCard.base_l2}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Level 3 (Senior):</span> <span class="font-medium text-gray-900">${salaryCard.base_l3}</span></div>
                </div>`;
            } else {
                // Standard data
                salaryHTML = `
                <div class="mt-3 pt-3 border-t border-gray-200 space-y-1 text-sm fade-in-element opacity-0 hidden transition-opacity duration-500">
                    ${header}
                    <div class="flex justify-between"><span class="text-gray-600">Base Salary:</span> <span class="font-medium text-gray-900">${salaryCard.base}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Employer Costs:</span> <span class="font-medium text-gray-900">${salaryCard.costs}</span></div>
                    <div class="flex justify-between border-t border-gray-100 mt-1 pt-1"><span class="text-gray-800 font-bold">Total Cost:</span> <span class="text-bot-total font-bold">${salaryCard.total}</span></div>
                </div>`;
            }
        }

        // 5. FOOTER: Verified Badge + Timestamp
        let verifiedBadgeHTML = '';
        if (source) {
            verifiedBadgeHTML = `
            <div class="group relative flex items-center gap-1 cursor-help fade-in-element opacity-0 hidden transition-opacity duration-500">
                <div class="bg-green-50 text-green-700 px-2 py-1 rounded-full text-[10px] font-bold border border-green-200 flex items-center gap-1 hover:bg-green-100 transition-colors">
                    <span class="material-symbols-rounded text-[14px] filled">verified</span> Verified
                </div>
                <div class="absolute bottom-full left-0 mb-2 w-max max-w-[250px] bg-gray-800 text-white text-xs p-2.5 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                    <p class="opacity-95 leading-tight break-words font-medium">Source: ${source}</p>
                    <div class="absolute top-full left-4 -mt-1 border-4 border-transparent border-t-gray-800"></div>
                </div>
            </div>`;
        }

        li.innerHTML = `
            <div class="flex items-start gap-3">
                <span class="material-symbols-rounded w-8 h-8 rounded-full bg-bot-light text-bot-main flex items-center justify-center text-lg flex-shrink-0">smart_toy</span>
                <div class="w-full max-w-[85%]">
                    <div class="bg-bot-light text-gray-700 p-3.5 rounded-2xl rounded-tl-none text-sm shadow-sm border border-gray-100 w-full relative">
                        <p class="leading-relaxed whitespace-pre-wrap type-text min-h-[1.2em]"></p>
                        ${salaryHTML}
                        ${jobSpecHTML}
                        ${tableHTML}
                        ${chartHTML}
                        <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-200/50 min-h-[24px]">
                            ${verifiedBadgeHTML}
                            <span class="text-[10px] text-gray-400 font-medium ml-auto">${time}</span>
                        </div>
                    </div>
                    <div class="suggestions-container mt-2 flex flex-wrap gap-2 animate-fade-in hidden"></div>
                </div>
            </div>`;

        chatBox.appendChild(li);

        const pTag = li.querySelector('.type-text');
        await typeWriter(pTag, text);

        li.querySelectorAll('.fade-in-element').forEach(el => {
            el.classList.remove('hidden');
            requestAnimationFrame(() => el.classList.remove('opacity-0'));
        });

        if (suggestions && suggestions.length > 0) {
            const sContainer = li.querySelector('.suggestions-container');
            sContainer.innerHTML = suggestions.map(q => {
                const safeQ = q.replace(/'/g, "\\'");
                return `<button onclick="handleSuggestion('${safeQ}')" class="px-3 py-1.5 border border-bot-gray rounded-[8px] text-xs text-gray-600 bg-white hover:bg-bot-teal hover:text-white hover:border-bot-teal transition-all shadow-sm">${q}</button>`
            }).join('');
            sContainer.classList.remove('hidden');
        }

        if (chartData) { renderChart(chartId, chartData); }
        scrollToBottom();
    }

    function renderChart(canvasId, chartData) {
        const ctxElement = document.getElementById(canvasId);
        if(!ctxElement) return;

        let type = chartData.type || 'bar';
        let labels = [];
        let datasets = [];

        if (chartData.labels && chartData.datasets) {
            labels = chartData.labels;
            datasets = chartData.datasets;
        } else if (chartData.data && (chartData.data.datasets || chartData.data.labels)) {
            labels = chartData.data.labels || [];
            datasets = chartData.data.datasets || [];
        } else if (chartData.data && !Array.isArray(chartData.data)) {
            labels = Object.keys(chartData.data);
            datasets = [{
                label: chartData.title || 'Value',
                data: Object.values(chartData.data),
                backgroundColor: ['#2C6CB7', '#66C3D0', '#AEDBE2', '#C4C4C5'],
                borderWidth: 0,
                borderRadius: 6
            }];
        }

        new Chart(ctxElement, {
            type: type,
            data: {
                labels: labels,
                datasets: datasets.map((ds, i) => ({
                    ...ds,
                    backgroundColor: ds.backgroundColor || ['#2C6CB7', '#66C3D0', '#AEDBE2', '#C4C4C5'][i % 4],
                    borderRadius: 6,
                    maxBarThickness: 50
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top', labels: { usePointStyle: true } } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' }, border: { display: false } },
                    x: { grid: { display: false }, border: { display: false } }
                }
            }
        });
    }

    function showTyping() {
        const li = document.createElement('li'); li.id = 'typing-indicator'; li.className = 'flex items-end gap-2 animate-slide-up';
        li.innerHTML = `<span class="material-symbols-rounded w-8 h-8 rounded-full bg-bot-light text-bot-main flex items-center justify-center text-lg flex-shrink-0 mb-1">smart_toy</span><div class="bg-bot-light px-4 py-3 rounded-2xl rounded-tl-none border border-gray-100"><div class="flex items-center gap-1 h-4"><div class="w-2 h-2 bg-bot-main rounded-full animate-wave dot-1"></div><div class="w-2 h-2 bg-bot-main rounded-full animate-wave dot-2"></div><div class="w-2 h-2 bg-bot-main rounded-full animate-wave dot-3"></div></div></div>`;
        chatBox.appendChild(li); scrollToBottom();
    }
    function removeTyping() { const el = document.getElementById('typing-indicator'); if (el) el.remove(); }
    function clearChat() { chatBox.innerHTML = ''; appendBotResponse("Chat cleared. Ready."); }
    function handleSuggestion(text) { chatInput.value = text; document.querySelector('form').requestSubmit(); }

    chatInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });

    window.jsPDF = window.jspdf.jsPDF;
    async function exportToPDF() {
        const originalChat = document.getElementById('chat-box');
        const container = document.createElement('div');
        container.style.cssText = "position:fixed;left:-10000px;top:0;width:800px;background:#fff;z-index:-9999;";
        document.body.appendChild(container);

        const clone = originalChat.cloneNode(true);
        clone.querySelectorAll('button').forEach(btn => btn.style.display = 'none');

        const originalCanvases = originalChat.querySelectorAll('canvas');
        const clonedCanvases = clone.querySelectorAll('canvas');
        originalCanvases.forEach((orig, i) => {
            if (clonedCanvases[i]) {
                const img = document.createElement('img');
                img.src = orig.toDataURL("image/png");
                img.style.width = '100%';
                clonedCanvases[i].parentNode.replaceChild(img, clonedCanvases[i]);
            }
        });

        clone.style.width = '750px'; clone.style.padding = '20px';
        const allElements = clone.querySelectorAll('*');
        allElements.forEach(el => { el.style.opacity = '1'; el.classList.remove('hidden', 'fade-in-element'); if(getComputedStyle(el).color !== 'rgb(255, 255, 255)') el.style.color = '#000'; });

        container.appendChild(clone);
        await new Promise(r => setTimeout(r, 800));

        html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            const imgHeight = canvas.height * 210 / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            pdf.addImage(imgData, 'PNG', 0, position, 210, imgHeight);
            heightLeft -= 297;
            while (heightLeft >= 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, 210, imgHeight); heightLeft -= 297; }
            pdf.save(`minerva-report-${Date.now()}.pdf`);
            document.body.removeChild(container);
        });
    }
    </script>
</body>
</html>
