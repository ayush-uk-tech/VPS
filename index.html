
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potentiam Ltd - Recruitment Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Modal specific styles */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden !important; }
        /* Tab Styles */
        .tab-btn.active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .tab-btn { color: #64748b; font-weight: 500; border-bottom: 2px solid transparent; }
        .tab-btn:hover:not(.active) { color: #334155; border-bottom: 2px solid #cbd5e1; }
        /* Login Screen Styles */
        #loginScreen { background-image: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 relative">

    <div id="loginScreen" class="fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <div class="bg-white/10 backdrop-blur-lg p-10 rounded-2xl shadow-2xl border border-white/20 text-center max-w-md w-full mx-4">
            <img src="https://github.com/Ayush01arya/TEST/raw/main/Potentiam_Logo-removebg-preview1.png" alt="Potentiam Logo" class="h-16 mx-auto mb-6 object-contain bg-white rounded-lg px-2 py-1">
            <h1 class="text-2xl font-bold mb-2">Internal Recruitment Portal</h1>
            <p class="text-slate-300 mb-8 text-sm">Please sign in with your Potentiam Microsoft account to access this tool.</p>
            <button id="msLoginBtn" class="w-full flex items-center justify-center gap-3 bg-white text-slate-900 font-semibold py-3 px-6 rounded-lg hover:bg-slate-50 transition-all shadow-lg active:scale-95">
                <svg class="w-5 h-5" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.5 0L0 0V10.5H10.5V0Z" fill="#F25022"/>
                    <path d="M21 0L10.5 0V10.5H21V0Z" fill="#7FBA00"/>
                    <path d="M10.5 10.5L0 10.5V21H10.5V10.5Z" fill="#00A4EF"/>
                    <path d="M21 10.5L10.5 10.5V21H21V10.5Z" fill="#FFB900"/>
                </svg>
                Sign in with Microsoft
            </button>
            <p id="authLoading" class="hidden mt-4 text-sm text-slate-400 animate-pulse">Authenticating...</p>
        </div>
        <p class="absolute bottom-8 text-slate-500 text-xs">Â© 2025 Potentiam Ltd. Authorized personnel only.</p>
    </div>

    <div id="appContent" class="hidden">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-4">
                        <img src="https://github.com/Ayush01arya/TEST/raw/main/Potentiam_Logo-removebg-preview1.png" alt="Potentiam Logo" class="h-10 w-auto object-contain">
                        <div class="hidden sm:block border-l border-slate-300 pl-4 h-8 flex items-center">
                            <div>
                                <h1 class="text-sm font-bold text-slate-900 tracking-tight leading-tight">Potentiam Ltd</h1>
                                <p class="text-[10px] text-slate-500 font-medium">Recruitment Portal</p>
                            </div>
                        </div>
                    </div>
                    <div class="relative ml-3">
                        <div class="flex items-center gap-3">
                            <button type="button" class="flex items-center max-w-xs rounded-full focus:outline-none" id="userMenuBtn" aria-expanded="false" aria-haspopup="true">
                                <div class="text-right mr-3 hidden md:block">
                                    <p class="text-sm font-medium text-gray-700" id="userNameDisplay">Loading...</p>
                                    <p class="text-xs text-gray-500" id="userEmailDisplay">Loading...</p>
                                </div>
                                <div class="h-9 w-9 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold border border-indigo-200" id="userInitials">U</div>
                                <svg class="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                        <div id="userDropdown" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <div class="px-4 py-3 border-b border-gray-100 md:hidden">
                                <p class="text-sm text-gray-900 font-medium" id="userNameMobile">User</p>
                                <p class="text-xs text-gray-500 truncate" id="userEmailMobile">email@example.com</p>
                            </div>
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 w-full text-left">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                    Sign out
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
            <div class="bg-white rounded-2xl shadow-xl overflow-visible flex flex-col min-h-[500px]">
                <div class="w-full bg-gradient-to-r from-[#1e293b] to-[#334155] h-32 relative overflow-hidden flex items-center px-6 md:px-10 shrink-0 rounded-t-2xl">
                     <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-5"></div>
                     <div class="absolute bottom-0 left-20 -mb-10 w-40 h-40 rounded-full bg-indigo-500 opacity-20"></div>
                     <div class="relative z-10">
                        <h2 class="text-2xl font-bold text-white" id="headerTitle">Recruitment Portal</h2>
                        <p class="text-slate-300 text-sm mt-1 max-w-lg" id="headerDesc">Manage interviews, reports, and role creation.</p>
                     </div>
                </div>

                <div class="flex border-b border-gray-200 px-6 md:px-10 pt-4 bg-white sticky top-0 z-20 overflow-x-auto">
                    <button onclick="switchTab('interview')" id="tab-btn-interview" class="tab-btn active px-4 py-3 mr-4 text-sm whitespace-nowrap focus:outline-none transition-colors">New Interview Request</button>
                    <button onclick="switchTab('report')" id="tab-btn-report" class="tab-btn px-4 py-3 mr-4 text-sm whitespace-nowrap focus:outline-none transition-colors">Download Candidate Report</button>
                    <button onclick="switchTab('create-role')" id="tab-btn-create-role" class="tab-btn px-4 py-3 text-sm whitespace-nowrap focus:outline-none transition-colors">Create New Role</button>
                </div>

                <div class="w-full p-6 md:p-10 relative">
                    <div id="errorAlert" class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r-md fade-in">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3"><p class="text-sm text-red-700" id="errorMsg">Something went wrong.</p></div>
                        </div>
                    </div>

                    <form id="interviewForm" class="space-y-8 fade-in">
                        <div>
                            <h3 class="text-lg font-medium leading-6 text-slate-900 border-b pb-2 mb-4 border-slate-100 flex items-center gap-2">
                                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">1</span> Role Details
                            </h3>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-6">
                                    <label class="block text-sm font-medium text-slate-700">Role / Position Name <span class="text-red-500">*</span></label>
                                    <div class="mt-1 relative role-dropdown-container" id="dropdown-interview">
                                        <button type="button" class="roleSelectBtn bg-white relative w-full border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-3 text-left cursor-default focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-colors group">
                                            <span class="block truncate text-gray-500 roleSelectLabel">Loading positions...</span>
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                                <svg class="h-5 w-5 text-gray-400 group-focus:text-indigo-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </button>
                                        <input type="hidden" name="roleName" class="roleNameInput">
                                        <input type="hidden" name="roleId" class="roleIdInput">
                                        <div class="roleOptionsContainer hidden absolute z-50 mt-1 w-full bg-white shadow-xl max-h-72 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                            <ul class="roleOptionsList divide-y divide-gray-100"></ul>
                                        </div>
                                        <p class="mt-1 text-xs text-red-600 hidden err-msg">Please select a role.</p>
                                    </div>
                                </div>
                                <div class="sm:col-span-6">
                                    <label for="roleDescription" class="block text-sm font-medium text-slate-700">Role Description (Optional)</label>
                                    <div class="mt-1">
                                        <textarea id="roleDescription" name="roleDescription" rows="3" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2.5" placeholder="Brief summary of key requirements..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium leading-6 text-slate-900 border-b pb-2 mb-4 border-slate-100 flex items-center gap-2">
                                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">2</span> Candidate Details
                            </h3>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-3">
                                    <label for="candidateName" class="block text-sm font-medium text-slate-700">Full Name <span class="text-red-500">*</span></label>
                                    <div class="mt-1">
                                        <input type="text" name="candidateName" id="candidateName" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2.5 border">
                                        <p class="mt-1 text-xs text-red-600 hidden err-candidateName">Name is required.</p>
                                    </div>
                                </div>
                                <div class="sm:col-span-3">
                                    <label for="candidatePhone" class="block text-sm font-medium text-slate-700">Phone Number</label>
                                    <div class="mt-1">
                                        <input type="text" name="candidatePhone" id="candidatePhone" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2.5 border">
                                    </div>
                                </div>
                                <div class="sm:col-span-6">
                                    <label for="candidateEmail" class="block text-sm font-medium text-slate-700">Email Address <span class="text-red-500">*</span></label>
                                    <div class="mt-1">
                                        <input type="email" name="candidateEmail" id="candidateEmail" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2.5 border" placeholder="candidate@example.com">
                                        <p class="mt-1 text-xs text-red-600 hidden err-candidateEmail">Valid email is required.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium leading-6 text-slate-900 border-b pb-2 mb-4 border-slate-100 flex items-center gap-2">
                                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">3</span> Recruiter Details
                            </h3>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-3">
                                    <label for="recruiterName" class="block text-sm font-medium text-slate-700">Your Name</label>
                                    <div class="mt-1">
                                        <input type="text" name="recruiterName" id="recruiterName" class="shadow-sm bg-gray-50 text-gray-500 block w-full sm:text-sm border-gray-300 rounded-md p-2.5 border cursor-not-allowed" readonly>
                                    </div>
                                </div>
                                <div class="sm:col-span-3">
                                    <label for="recruiterEmail" class="block text-sm font-medium text-slate-700">Your Email</label>
                                    <div class="mt-1">
                                        <input type="email" name="recruiterEmail" id="recruiterEmail" class="shadow-sm bg-gray-50 text-gray-500 block w-full sm:text-sm border-gray-300 rounded-md p-2.5 border cursor-not-allowed" readonly>
                                    </div>
                                    <p class="mt-1 text-xs text-slate-400">Auto-filled from login</p>
                                </div>
                            </div>
                        </div>
                        <div class="pt-5 flex items-center justify-end gap-3">
                            <button type="button" class="clearBtn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none transition-colors">Clear</button>
                            <button type="submit" class="submitBtn inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                                <span class="btnText">Start Interview Process</span>
                                <div class="btnSpinner loader ml-2 hidden"></div>
                            </button>
                        </div>
                    </form>

                    <form id="reportForm" class="space-y-8 hidden fade-in">
                        <div>
                            <h3 class="text-lg font-medium leading-6 text-slate-900 border-b pb-2 mb-4 border-slate-100 flex items-center gap-2">
                                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">1</span> Select Role
                            </h3>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-6">
                                    <label class="block text-sm font-medium text-slate-700">Role / Position Name <span class="text-red-500">*</span></label>
                                    <div class="mt-1 relative role-dropdown-container" id="dropdown-report">
                                        <button type="button" class="roleSelectBtn bg-white relative w-full border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-3 text-left cursor-default focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-colors group">
                                            <span class="block truncate text-gray-500 roleSelectLabel">Loading positions...</span>
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                                <svg class="h-5 w-5 text-gray-400 group-focus:text-indigo-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </button>
                                        <input type="hidden" name="roleName" class="roleNameInput">
                                        <input type="hidden" name="roleId" class="roleIdInput">
                                        <div class="roleOptionsContainer hidden absolute z-50 mt-1 w-full bg-white shadow-xl max-h-72 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                            <ul class="roleOptionsList divide-y divide-gray-100"></ul>
                                        </div>
                                        <p class="mt-1 text-xs text-red-600 hidden err-msg">Please select a role.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium leading-6 text-slate-900 border-b pb-2 mb-4 border-slate-100 flex items-center gap-2">
                                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">2</span> Candidate Details
                            </h3>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium text-slate-700">Candidate Name <span class="text-red-500">*</span></label>
                                    
                                    <div class="mt-1 relative candidate-dropdown-container" id="dropdown-candidate">
                                        <button type="button" class="candidateSelectBtn bg-white relative w-full border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-3 text-left cursor-default focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-colors group">
                                            <span class="block truncate text-gray-500 candidateSelectLabel">Select Role first...</span>
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                                <svg class="h-5 w-5 text-gray-400 group-focus:text-indigo-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </button>
                                        <input type="hidden" name="rep_candidateEmail" id="rep_candidateEmail">
                                        <div class="candidateOptionsContainer hidden absolute z-50 mt-1 w-full bg-white shadow-xl max-h-72 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                            <ul class="candidateOptionsList divide-y divide-gray-100"></ul>
                                        </div>
                                        <p class="mt-1 text-xs text-red-600 hidden err-candidateEmail">Please select a candidate.</p>
                                    </div>
                                </div>
                                <div class="sm:col-span-3">
                                    <label for="rep_recruiterEmail" class="block text-sm font-medium text-slate-700">Recruiter Email</label>
                                    <div class="mt-1">
                                        <input type="email" name="rep_recruiterEmail" id="rep_recruiterEmail" class="shadow-sm bg-gray-50 text-gray-500 block w-full sm:text-sm border-gray-300 rounded-md p-2.5 border cursor-not-allowed" readonly>
                                    </div>
                                    <p class="mt-1 text-xs text-slate-400">Auto-filled from login</p>
                                </div>
                            </div>
                        </div>
                        <div class="pt-5 flex items-center justify-end gap-3">
                            <button type="button" class="clearBtn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none transition-colors">Clear</button>
                            <button type="submit" class="submitBtn inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                                <span class="btnText">Send Report Request</span>
                                <div class="btnSpinner loader ml-2 hidden"></div>
                            </button>
                        </div>
                    </form>

                    <form id="createRoleForm" class="space-y-8 hidden fade-in">
                        <div>
                            <h3 class="text-lg font-medium leading-6 text-slate-900 border-b pb-2 mb-4 border-slate-100 flex items-center gap-2">
                                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">1</span> Role Definition
                            </h3>
                            <div class="grid grid-cols-1 gap-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">New Role Name <span class="text-red-500">*</span></label>
                                    <div class="mt-1">
                                        <input type="text" name="newRoleName" id="newRoleName" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2.5 border" placeholder="e.g. Senior Data Scientist">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center border-b pb-2 mb-4 border-slate-100">
                                <h3 class="text-lg font-medium leading-6 text-slate-900 flex items-center gap-2">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">2</span> Interview Questions
                                </h3>
                                <button type="button" id="addQuestionBtn" class="text-xs text-indigo-600 hover:text-indigo-800 font-semibold border border-indigo-200 bg-indigo-50 px-3 py-1 rounded transition-colors"> + Add Question </button>
                            </div>
                            <div id="questionsContainer" class="space-y-5">
                                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 relative question-block">
                                    <div class="flex justify-between mb-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Question 1</label>
                                    </div>
                                    <input type="text" class="q-title shadow-sm block w-full sm:text-sm border-gray-300 rounded-md p-2 mb-2 border" placeholder="Question Title (e.g. Technical Skills)">
                                    <textarea class="q-desc shadow-sm block w-full sm:text-sm border-gray-300 rounded-md p-2 border" rows="2" placeholder="Description / What to ask..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="pt-5 flex items-center justify-end gap-3">
                            <button type="button" class="clearBtn bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none transition-colors">Clear</button>
                            <button type="submit" class="submitBtn inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                                <span class="btnText">Preview & Create</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="statusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[100] flex items-center justify-center opacity-0 modal">
        <div class="relative p-5 border w-96 shadow-lg rounded-lg bg-white transform transition-all scale-95" id="modalContent">
            <div class="mt-3 text-center">
                <div id="modalIconContainer" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4"></div>
                <h3 id="modalTitle" class="text-xl leading-6 font-bold text-gray-900"></h3>
                <div class="mt-2 px-2 py-3"><p id="modalBody" class="text-sm text-gray-500"></p></div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalBtn" class="px-6 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="warningModal" class="fixed inset-0 bg-gray-600 bg-opacity-70 overflow-y-auto h-full w-full hidden z-[110] flex items-center justify-center fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="bg-amber-100 p-2 rounded-full"><svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-900">That's a lot of questions!</h3>
            </div>
            <p class="text-slate-600 text-sm mb-6">4 questions are usually enough. Are you sure you want to add another one?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelAddQ" class="px-4 py-2 bg-white border border-gray-300 rounded text-slate-700 hover:bg-gray-50 text-sm">Cancel</button>
                <button id="confirmAddQ" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">Yes, I'm stubborn</button>
            </div>
        </div>
    </div>

    <div id="previewModal" class="fixed inset-0 bg-gray-600 bg-opacity-70 overflow-y-auto h-full w-full hidden z-[120] flex items-center justify-center fade-in">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-0 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 px-6 py-4">
                <h3 class="text-lg font-bold text-white">Preview New Role</h3>
                <p class="text-indigo-200 text-xs">Review details before creating.</p>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-6">
                    <p class="text-xs text-slate-500 uppercase font-bold">Role Name</p>
                    <p class="text-xl font-semibold text-slate-900" id="previewRoleName">--</p>
                </div>
                <p class="text-xs text-slate-500 uppercase font-bold mb-3">Interview Questions</p>
                <div id="previewQuestionsList" class="space-y-3"></div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-between items-center border-t border-gray-200">
                <button id="closePreviewBtn" class="text-slate-500 hover:text-slate-800 text-sm font-medium">Edit</button>
                <button id="finalApproveBtn" class="px-6 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 text-sm font-bold flex items-center">
                    <span id="finalBtnText">Approve & Create</span>
                    <div id="finalSpinner" class="loader ml-2 hidden border-t-white border-white/30"></div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const WEBHOOK_INTERVIEW = "https://n8n.srv1153795.hstgr.cloud/webhook/d48e8eb8-3408-475a-a852-5d0f72f17e73";
        const WEBHOOK_REPORT = "https://n8n.srv1153795.hstgr.cloud/webhook/8d690cc1-cd2d-45c3-9e4e-5ed993f44df6";
        const WEBHOOK_CREATE_ROLE = "https://n8n.srv1153795.hstgr.cloud/webhook/0a40e6c4-1eb4-48e2-bb95-ba9d26f8fc1a";
        
        // !!! IMPORTANT: ENTER YOUR HIREFLIX API KEY HERE !!!
        const HIREFLIX_API_KEY = "56"; 
        
        const HIREFLIX_API_URL = "https://api.hireflix.com/me";

        // --- MSAL CONFIGURATION (AZURE AD) ---
        const msalConfig = {
            auth: {
                clientId: "1", // e.g. "a1b2c3d4-..."
                authority: "https://login.microsoftonline.com/a5",
                redirectUri: "http://72.61.202.140:8080/"
            },
            cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
        };

        const loginRequest = { scopes: ["User.Read"] };
        let myMSALObj = null;
        let username = "";
        let userEmail = "";

        // --- AUTH INITIALIZATION ---
        async function initAuth() {
            try {
                myMSALObj = new msal.PublicClientApplication(msalConfig);
                await myMSALObj.initialize();
                const response = await myMSALObj.handleRedirectPromise();
                if (response) {
                    handleResponse(response);
                } else {
                    const currentAccounts = myMSALObj.getAllAccounts();
                    if (currentAccounts.length > 0) handleResponse({ account: currentAccounts[0] });
                }
            } catch (error) { console.error("Auth Init Error:", error); }
        }

        function handleResponse(response) {
            if (response && response.account) {
                username = response.account.name;
                userEmail = response.account.username;
                document.getElementById('userNameDisplay').textContent = username;
                document.getElementById('userEmailDisplay').textContent = userEmail;
                document.getElementById('userNameMobile').textContent = username;
                document.getElementById('userEmailMobile').textContent = userEmail;
                document.getElementById('userInitials').textContent = username.charAt(0).toUpperCase();
                document.getElementById('recruiterName').value = username;
                document.getElementById('recruiterEmail').value = userEmail;
                document.getElementById('rep_recruiterEmail').value = userEmail;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                
                // Fetch Dynamic Roles on Login
                fetchHireflixRoles();
            }
        }

        function signIn() {
            document.getElementById('authLoading').classList.remove('hidden');
            myMSALObj.loginPopup(loginRequest).then(handleResponse).catch(e => document.getElementById('authLoading').classList.add('hidden'));
        }
        function signOut() {
            const logoutRequest = { account: myMSALObj.getAccountByUsername(userEmail), mainWindowRedirectUri: window.location.href };
            myMSALObj.logoutPopup(logoutRequest).then(() => window.location.reload());
        }

        document.getElementById('msLoginBtn').addEventListener('click', signIn);
        document.getElementById('logoutBtn').addEventListener('click', signOut);
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userDropdown = document.getElementById('userDropdown');
        userMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); userDropdown.classList.toggle('hidden'); });
        document.addEventListener('click', (e) => { if (!userMenuBtn.contains(e.target)) userDropdown.classList.add('hidden'); });
        window.addEventListener('load', initAuth);

        // --- DYNAMIC DATA LOGIC ---

        // Helper for Hireflix API Calls
        async function callHireflixAPI(query, variables = {}) {
            try {
                const response = await fetch(HIREFLIX_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': HIREFLIX_API_KEY
                    },
                    body: JSON.stringify({ query, variables })
                });
                const result = await response.json();
                if (result.errors) throw new Error(result.errors[0].message);
                return result.data;
            } catch (error) {
                console.error("Hireflix API Error:", error);
                return null;
            }
        }

        // 1. Fetch Active Positions
        let activePositions = [];
        async function fetchHireflixRoles() {
            const query = `query { info { company { id name positions { id name } } } }`;
            const data = await callHireflixAPI(query);
            
            if (data && data.info && data.info.company && data.info.company.positions) {
                activePositions = data.info.company.positions;
                // Update dropdowns with new data
                populateRoleDropdown('dropdown-interview', activePositions);
                populateRoleDropdown('dropdown-report', activePositions);
            } else {
                // Fallback or Alert
                console.warn("Could not fetch positions");
            }
        }

        // 2. Fetch Candidates for specific Role (For Report Tab)
        async function fetchCandidatesForRole(roleId) {
            const query = `query GetAllInterviews($positionId: String!) { position(id: $positionId) { id name paginatedInterviews(pagination: { limit: 500 }) { results { id candidate { email fullName } } } }}`;
            const variables = { positionId: roleId };
            
            // Show loading state in candidate dropdown
            const btn = document.querySelector('#dropdown-candidate .candidateSelectLabel');
            btn.textContent = "Loading candidates...";
            
            const data = await callHireflixAPI(query, variables);
            
            if (data && data.position && data.position.paginatedInterviews) {
                const interviews = data.position.paginatedInterviews.results;
                // Extract unique candidates (based on email)
                const uniqueCandidates = [];
                const emails = new Set();
                
                interviews.forEach(item => {
                    if (item.candidate && !emails.has(item.candidate.email)) {
                        emails.add(item.candidate.email);
                        uniqueCandidates.push(item.candidate);
                    }
                });
                
                populateCandidateDropdown(uniqueCandidates);
            } else {
                btn.textContent = "No candidates found";
            }
        }

        // --- DROPDOWN LOGIC ---

        // Logic for Role Dropdowns (Updated to accept data)
        function populateRoleDropdown(containerId, positionsData) {
            const container = document.getElementById(containerId);
            if(!container) return;
            
            const label = container.querySelector('.roleSelectLabel');
            const list = container.querySelector('.roleOptionsList');
            const nameInput = container.querySelector('.roleNameInput');
            const idInput = container.querySelector('.roleIdInput');
            
            // Reset List
            list.innerHTML = "";
            label.textContent = "Select a position...";

            positionsData.forEach(pos => {
                const li = document.createElement('li');
                li.className = 'cursor-pointer select-none relative py-3 pl-3 pr-9 hover:bg-indigo-50 transition-colors border-b border-gray-50 last:border-0';
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-slate-800 text-sm">${pos.name}</span>
                        <span class="text-[10px] text-slate-400 font-mono tracking-wide mt-0.5 uppercase">ID: ${pos.id}</span>
                    </div>
                `;
                li.addEventListener('click', () => {
                    nameInput.value = pos.name;
                    idInput.value = pos.id;
                    label.textContent = pos.name;
                    label.classList.remove('text-gray-500');
                    label.classList.add('text-slate-900', 'font-medium');
                    container.querySelector('.roleOptionsContainer').classList.add('hidden');
                    
                    // SPECIAL LOGIC FOR REPORT FORM
                    if (containerId === 'dropdown-report') {
                        // When role is selected in Report tab, fetch candidates
                        document.getElementById('rep_candidateEmail').value = ""; // Clear old candidate
                        document.querySelector('#dropdown-candidate .candidateSelectLabel').textContent = "Loading...";
                        fetchCandidatesForRole(pos.id);
                    }
                });
                list.appendChild(li);
            });
        }

        function setupRoleDropdownUI(containerId) {
            const container = document.getElementById(containerId);
            const btn = container.querySelector('.roleSelectBtn');
            const listContainer = container.querySelector('.roleOptionsContainer');
            
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.roleOptionsContainer, .candidateOptionsContainer').forEach(el => el.classList.add('hidden'));
                listContainer.classList.remove('hidden');
            });
        }
        setupRoleDropdownUI('dropdown-interview');
        setupRoleDropdownUI('dropdown-report');

        // Logic for Candidate Dropdown (Report Form)
        function populateCandidateDropdown(candidatesData) {
            const container = document.getElementById('dropdown-candidate');
            const label = container.querySelector('.candidateSelectLabel');
            const list = container.querySelector('.candidateOptionsList');
            const hiddenEmailInput = document.getElementById('rep_candidateEmail');
            
            list.innerHTML = "";
            
            if (candidatesData.length === 0) {
                label.textContent = "No candidates found for this role";
                return;
            }

            label.textContent = "Select a candidate...";

            candidatesData.forEach(candidate => {
                const li = document.createElement('li');
                li.className = 'cursor-pointer select-none relative py-3 pl-3 pr-9 hover:bg-indigo-50 transition-colors border-b border-gray-50 last:border-0';
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-slate-800 text-sm">${candidate.fullName}</span>
                        <span class="text-xs text-slate-500">${candidate.email}</span>
                    </div>
                `;
                li.addEventListener('click', () => {
                    // Update UI
                    label.textContent = candidate.fullName;
                    label.classList.remove('text-gray-500');
                    label.classList.add('text-slate-900', 'font-medium');
                    
                    // Update Hidden Input for Webhook
                    hiddenEmailInput.value = candidate.email;
                    
                    container.querySelector('.candidateOptionsContainer').classList.add('hidden');
                    container.querySelector('.err-candidateEmail').classList.add('hidden');
                });
                list.appendChild(li);
            });
        }

        // Candidate Dropdown UI Toggle
        const candidateContainer = document.getElementById('dropdown-candidate');
        const candidateBtn = candidateContainer.querySelector('.candidateSelectBtn');
        const candidateListContainer = candidateContainer.querySelector('.candidateOptionsContainer');

        candidateBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.roleOptionsContainer, .candidateOptionsContainer').forEach(el => el.classList.add('hidden'));
            if(candidateListContainer.children.length > 0) {
                candidateListContainer.classList.remove('hidden');
            }
        });

        // Close dropdowns on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.role-dropdown-container') && !e.target.closest('.candidate-dropdown-container')) {
                document.querySelectorAll('.roleOptionsContainer, .candidateOptionsContainer').forEach(el => el.classList.add('hidden'));
            }
        });

        // --- GLOBAL SELECTORS & TAB LOGIC ---
        const errorAlert = document.getElementById('errorAlert');
        const errorMsg = document.getElementById('errorMsg');
        const statusModal = document.getElementById('statusModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalIconContainer = document.getElementById('modalIconContainer');
        const closeModalBtn = document.getElementById('closeModalBtn');

        window.switchTab = function(tabId) { 
            errorAlert.classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-btn-${tabId}`).classList.add('active');
            document.getElementById('interviewForm').classList.add('hidden');
            document.getElementById('reportForm').classList.add('hidden');
            document.getElementById('createRoleForm').classList.add('hidden');
            
            if(tabId === 'interview') document.getElementById('interviewForm').classList.remove('hidden');
            else if (tabId === 'report') document.getElementById('reportForm').classList.remove('hidden');
            else if (tabId === 'create-role') document.getElementById('createRoleForm').classList.remove('hidden');
        }

        // Form Reset
        function resetForm(formId) {
            const form = document.getElementById(formId);
            form.reset();
            const dropdown = form.querySelector('.role-dropdown-container');
            if(dropdown){
                dropdown.querySelector('.roleNameInput').value = '';
                dropdown.querySelector('.roleIdInput').value = '';
                dropdown.querySelector('.roleSelectLabel').textContent = 'Select a position...';
                dropdown.querySelector('.roleSelectLabel').classList.add('text-gray-500');
            }
            if(formId === 'reportForm') {
                const cLabel = form.querySelector('.candidateSelectLabel');
                cLabel.textContent = 'Select Role first...';
                cLabel.classList.add('text-gray-500');
                form.querySelector('.candidateOptionsList').innerHTML = '';
            }
            document.getElementById('recruiterName').value = username;
            document.getElementById('recruiterEmail').value = userEmail;
            document.getElementById('rep_recruiterEmail').value = userEmail;
            form.querySelectorAll('.text-red-600').forEach(el => el.classList.add('hidden'));
            form.querySelectorAll('input, textarea').forEach(el => el.classList.remove('border-red-500'));
        }

        document.querySelectorAll('.clearBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const formId = e.target.closest('form').id;
                if(confirm('Clear this form?')) {
                    resetForm(formId);
                    if(formId === 'createRoleForm') {
                        questionsContainer.innerHTML = '';
                        questionCount = 0;
                        appendQuestionHTML();
                    }
                }
            });
        });

        function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

        function showStatusModal(type, title, message) {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            modalIconContainer.className = 'mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4';
            if (type === 'success') {
                modalIconContainer.classList.add('bg-green-100');
                modalIconContainer.innerHTML = `<svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            } else {
                modalIconContainer.classList.add('bg-amber-100');
                modalIconContainer.innerHTML = `<svg class="h-8 w-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            }
            statusModal.classList.remove('hidden');
            setTimeout(() => { statusModal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }

        closeModalBtn.addEventListener('click', () => {
            statusModal.classList.add('opacity-0'); modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95');
            setTimeout(() => { statusModal.classList.add('hidden'); }, 300);
        });

        // --- CREATE ROLE LOGIC ---
        let questionCount = 1;
        const maxBeforeWarning = 4;
        const questionsContainer = document.getElementById('questionsContainer');
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        const warningModal = document.getElementById('warningModal');
        const previewModal = document.getElementById('previewModal');

        function appendQuestionHTML() {
            questionCount++;
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-4 rounded-lg border border-slate-200 relative question-block fade-in";
            div.innerHTML = `<div class="flex justify-between mb-2"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Question ${questionCount}</label></div><input type="text" class="q-title shadow-sm block w-full sm:text-sm border-gray-300 rounded-md p-2 mb-2 border" placeholder="Question Title"><textarea class="q-desc shadow-sm block w-full sm:text-sm border-gray-300 rounded-md p-2 border" rows="2" placeholder="Description..."></textarea>`;
            questionsContainer.appendChild(div);
        }

        addQuestionBtn.addEventListener('click', () => { if (questionCount >= maxBeforeWarning) warningModal.classList.remove('hidden'); else appendQuestionHTML(); });
        document.getElementById('cancelAddQ').addEventListener('click', () => warningModal.classList.add('hidden'));
        document.getElementById('confirmAddQ').addEventListener('click', () => { warningModal.classList.add('hidden'); appendQuestionHTML(); });

        const createRoleForm = document.getElementById('createRoleForm');
        let pendingRoleData = null;

        createRoleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            errorAlert.classList.add('hidden');
            const roleNameInput = document.getElementById('newRoleName');
            const roleName = roleNameInput.value.trim();
            if(!roleName) { roleNameInput.classList.add('border-red-500'); return; } else { roleNameInput.classList.remove('border-red-500'); }
            const qTitles = document.querySelectorAll('.q-title');
            const qDescs = document.querySelectorAll('.q-desc');
            const questions = [];
            let hasEmpty = false;
            qTitles.forEach((t, index) => {
                const title = t.value.trim();
                if(!title) { t.classList.add('border-red-500'); hasEmpty = true; } else { t.classList.remove('border-red-500'); }
                questions.push({ title, description: qDescs[index].value.trim() });
            });
            if(hasEmpty) return;
            pendingRoleData = { roleName, questions, creator: userEmail };
            document.getElementById('previewRoleName').textContent = roleName;
            const previewList = document.getElementById('previewQuestionsList');
            previewList.innerHTML = '';
            questions.forEach((q, i) => {
                const item = document.createElement('div');
                item.className = "bg-slate-50 p-3 rounded border border-slate-200";
                item.innerHTML = `<p class="text-sm font-bold text-slate-800"><span class="text-indigo-600 mr-2">Q${i+1}.</span> ${q.title}</p>${q.description ? `<p class="text-xs text-slate-500 mt-1 ml-6">${q.description}</p>` : ''}`;
                previewList.appendChild(item);
            });
            previewModal.classList.remove('hidden');
        });

        document.getElementById('closePreviewBtn').addEventListener('click', () => previewModal.classList.add('hidden'));

        document.getElementById('finalApproveBtn').addEventListener('click', () => {
            const btnText = document.getElementById('finalBtnText');
            const spinner = document.getElementById('finalSpinner');
            const btn = document.getElementById('finalApproveBtn');
            btnText.textContent = "Creating..."; spinner.classList.remove('hidden'); btn.disabled = true;
            fetch(WEBHOOK_CREATE_ROLE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pendingRoleData)
            })
            .then(res => { if(res.ok) return res.json(); throw new Error("Failed"); })
            .then(() => {
                previewModal.classList.add('hidden');
                showStatusModal('success', 'Role Created!', `The role "${pendingRoleData.roleName}" has been successfully created.`);
                resetForm('createRoleForm');
                questionsContainer.innerHTML = ''; questionCount = 0; appendQuestionHTML();
            })
            .catch(() => { previewModal.classList.add('hidden'); showStatusModal('warning', 'Error', 'Could not create role. Please try again.'); })
            .finally(() => { btnText.textContent = "Approve & Create"; spinner.classList.add('hidden'); btn.disabled = false; });
        });

        // --- SUBMIT LOGIC (Interview & Report) ---
        function handleFormSubmit(e, webhookUrl, isInterviewForm) {
            e.preventDefault();
            errorAlert.classList.add('hidden');
            const form = e.target;
            const btn = form.querySelector('.submitBtn');
            const btnText = form.querySelector('.btnText');
            const spinner = form.querySelector('.btnSpinner');
            if(isInterviewForm) document.getElementById('recruiterEmail').value = userEmail;
            else document.getElementById('rep_recruiterEmail').value = userEmail;

            const formData = new FormData(form);
            let isValid = true;
            
            // Validate Role
            const roleName = formData.get('roleName');
            const roleBtn = form.querySelector('.roleSelectBtn');
            const roleErr = form.querySelector('.role-dropdown-container .err-msg');
            if(!roleName) {
                if(roleBtn) { roleBtn.classList.add('border-red-500'); roleBtn.classList.remove('border-gray-300'); }
                if(roleErr) roleErr.classList.remove('hidden');
                isValid = false;
            } else {
                if(roleBtn) { roleBtn.classList.remove('border-red-500'); roleBtn.classList.add('border-gray-300'); }
                if(roleErr) roleErr.classList.add('hidden');
            }

            // Validate Candidate Email (Report Form uses hidden input)
            if(!isInterviewForm) {
                const repEmail = document.getElementById('rep_candidateEmail').value;
                const repErr = form.querySelector('.err-candidateEmail');
                if(!repEmail) {
                    form.querySelector('.candidateSelectBtn').classList.add('border-red-500');
                    repErr.classList.remove('hidden');
                    isValid = false;
                } else {
                    form.querySelector('.candidateSelectBtn').classList.remove('border-red-500');
                    repErr.classList.add('hidden');
                }
            } else {
                // Validate Manual Email for Interview Form
                 const emailInput = form.querySelector('input[name="candidateEmail"]');
                 if(emailInput) {
                     if(!isValidEmail(emailInput.value)) { emailInput.classList.add('border-red-500'); isValid = false; }
                     else emailInput.classList.remove('border-red-500');
                 }
                 const nameInput = form.querySelector('input[name="candidateName"]');
                 if(nameInput) {
                     if(!nameInput.value) { nameInput.classList.add('border-red-500'); isValid = false; }
                     else nameInput.classList.remove('border-red-500');
                 }
            }

            if(!isValid) return;

            const originalText = btnText.textContent;
            btnText.textContent = "Processing..."; spinner.classList.remove('hidden'); btn.disabled = true; form.classList.add('opacity-70');
            formData.append('timestamp', new Date().toISOString());

            fetch(webhookUrl, { method: 'POST', body: formData })
            .then(async response => {
                const contentType = response.headers.get("content-type");
                let data = {};
                if (contentType && contentType.indexOf("application/json") !== -1) data = await response.json();

                if (isInterviewForm) {
                    if (response.status === 409 || data.code === 409 || data.status === 'exists') showStatusModal('warning', 'Candidate Already Exists', 'This candidate is already registered in our system for this role.');
                    else if (response.ok || data.code === 201 || data.status === 'created') { showStatusModal('success', 'Request Submitted Successfully!', `Process initiated. Confirmation sent to ${userEmail}.`); resetForm(form.id); }
                    else throw new Error(data.message || `Server returned ${response.status}`);
                } else {
                    if (data.status === 'exists' || data.exists === true) { showStatusModal('success', 'Report Sent!', `Candidate report found and sent to ${userEmail}.`); resetForm(form.id); }
                    else if (data.status === 'not_exists' || data.exists === false) showStatusModal('warning', 'Report Not Found', 'Candidate does not exist for this position.');
                    else if(response.ok) { showStatusModal('success', 'Request Sent', `Request processed. Check ${userEmail}.`); resetForm(form.id); }
                    else throw new Error(`Server returned ${response.status}`);
                }
            })
            .catch(() => { errorMsg.textContent = "Network error or Server issue."; errorAlert.classList.remove('hidden'); window.scrollTo({ top: 0, behavior: 'smooth' }); })
            .finally(() => { btnText.textContent = originalText; spinner.classList.add('hidden'); btn.disabled = false; form.classList.remove('opacity-70'); });
        }

        document.getElementById('interviewForm').addEventListener('submit', (e) => handleFormSubmit(e, WEBHOOK_INTERVIEW, true));
        document.getElementById('reportForm').addEventListener('submit', (e) => handleFormSubmit(e, WEBHOOK_REPORT, false));

    </script>
</body>
</html>
